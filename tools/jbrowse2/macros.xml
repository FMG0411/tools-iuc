<?xml version="1.0"?>
<macros>
    <token name="@TOOL_VERSION@">3.6.4</token>
    <xml name="requirements">
        <requirements>
            <requirement type="package" version="@TOOL_VERSION@">jbrowse2</requirement>
            <requirement type="package" version="1.22.1">samtools</requirement>
            <requirement type="package" version="1.11">tabix</requirement>
            <yield/>
        </requirements>
    </xml>
    <token name="@WRAPPER_VERSION@">galaxy0</token>
    <token name="@ATTRIBUTION@"><![CDATA[
**Attribution**

This Galaxy tool relies on JBrowse2, maintained by the GMOD Community. The Galaxy wrapper is developed by the IUC.
]]>
    </token>

    <xml name="genome_selector"
        token_help=""
        token_label="Fasta sequences"
        token_optional="False" >
        <conditional name="reference_genome">
            <param help="Built-in references" label="Reference genome to display" name="genome_type_select" type="select">
                <option selected="True" value="indexed">Use a built-in genome</option>
                <option value="history">Use a genome from history</option>
            </param>
            <when value="indexed">
                <param
                help="@HELP@"
                label="@LABEL@"
                name="genomes"
                type="select"
                optional="@OPTIONAL@"
                >
                    <options from_data_table="all_fasta">
                        <filter column="2" type="sort_by" />
                        <validator message="No genomes are available for the selected input dataset" type="no_options" />
                    </options>
                </param>
            </when>
            <when value="history">
                <param
                format="fasta"
                label="@LABEL@"
                help="@HELP@"
                name="genomes"
                type="data"
                optional="@OPTIONAL@"
                multiple="True" />
            </when>
        </conditional>
    </xml>

    <xml name="general_options">
        <section name="jbgen" title="General JBrowse Options [Advanced]" expanded="false">
            <param label="Enable analytics" help="Will send usage data to Google Analytics, see https://github.com/GMOD/jbrowse-components/issues/1166" name="enableAnalytics" type="boolean" checked="false" truevalue="true" falsevalue="false" />

            <param name="primary_color" type="color" label="Primary color" value="#0D233F">
                <sanitizer>
                    <valid initial="string.ascii_letters,string.digits">
                        <add value="#" />
                    </valid>
                </sanitizer>
            </param>
            <param name="secondary_color" type="color" label="Secondary color" value="#721E63">
                <sanitizer>
                <valid initial="string.ascii_letters,string.digits">
                    <add value="#" />
                </valid>
                </sanitizer>
            </param>
            <param name="tertiary_color" type="color" label="Tertiary color" value="#135560">
                <sanitizer>
                    <valid initial="string.ascii_letters,string.digits">
                        <add value="#" />
                    </valid>
                </sanitizer>
            </param>
            <param name="quaternary_color" type="color" label="Quaternary color" value="#FFB11D">
                <sanitizer>
                    <valid initial="string.ascii_letters,string.digits">
                        <add value="#" />
                    </valid>
                </sanitizer>
            </param>

            <param label="Font size" name="font_size" type="integer" value="10" />
        </section>
    </xml>

    <xml name="track_metadata">
        <section name="metadata" title="Track metadata [Advanced]" expanded="false">
            <param name="galaxy_metadata" label="Show Galaxy track metadata" type="boolean" checked="true" truevalue="true" falsevalue="false" help="Make Galaxy metadata available in 'About track' window and faceted track selector" />
            <param name="metadata_bonus" type="data" format="tsv" label="Additional track metadata" optional="true" help="Display additional track metadata from a TSV file" />
        </section>
    </xml>

    <xml name="track_visibility">
        <param type="select" label="Track Visibility" name="track_visibility">
            <option value="default_off">Off when browser opens</option>
            <option value="default_on" selected="true">On when browser opens</option>
        </param>
    </xml>

    <xml name="track_styling_linear">

        <param name="display_mode" type="select" label="Display mode">
            <option value="normal" selected="true">normal</option>
            <option value="compact">compact</option>
            <option value="reducedRepresentation">reducedRepresentation</option>
            <option value="collapse">collapse</option>
        </param>

        <param label="Show labels" name="show_labels" type="boolean" checked="true" truevalue="true" falsevalue="false" />

        <param label="Features label"
                type="text"
                name="labels_name"
                value="jexl:get(feature,'name') || get(feature,'id')"
                help="See https://jbrowse.org/jb2/docs/config_guide/#configuration-callbacks for syntax">
            <expand macro="jexl_sanitize" />
        </param>

        <param label="Show descriptions" name="show_descriptions" type="boolean" checked="true" truevalue="true" falsevalue="false" />

        <param label="Features description"
                type="text"
                name="descriptions_name"
                value="jexl:get(feature,'note') || get(feature,'description')"
                help="See https://jbrowse.org/jb2/docs/config_guide/#configuration-callbacks for syntax">
            <expand macro="jexl_sanitize" />
        </param>

        <param label="Max height" name="max_height" type="integer" value="600" help="Maximum height that the track is permitted to reach in pixels."/>
    </xml>

    <xml name="track_styling_arc">

        <param name="display_mode" type="select" label="Display mode">
            <option value="arcs" selected="true">arcs</option>
            <option value="semicircles">semicircles</option>
        </param>

        <param label="Arcs label"
                type="text"
                name="labels_name"
                value="jexl:get(feature,'score')"
                help="See https://jbrowse.org/jb2/docs/config_guide/#configuration-callbacks for syntax">
            <expand macro="jexl_sanitize" />
        </param>
    </xml>

    <xml name="track_styling_feature">
        <section name="jbstyle" title="JBrowse Styling Options [Advanced]" expanded="false">
        <conditional name="track_style">
            <param name="display" type="select" label="Display style" help="How the track will be displayed by default">
                <option value="LinearBasicDisplay" selected="true">LinearBasicDisplay</option>
                <option value="LinearArcDisplay">LinearArcDisplay</option>
            </param>
            <when value="LinearBasicDisplay">
                <expand macro="track_styling_linear"/>
            </when>
            <when value="LinearArcDisplay">
                <expand macro="track_styling_arc"/>
            </when>
        </conditional>
        </section>
    </xml>

    <xml name="track_styling_xam">
        <section name="jbstyle" title="JBrowse Styling Options [Advanced]" expanded="false">
            <conditional name="track_style">
                <param name="display" type="select" label="Display style" help="How the track will be displayed by default">
                    <option value="LinearAlignmentsDisplay" selected="true">Alignments (Pileup + SNP Coverage)</option>
                    <option value="LinearPileupDisplay">Pileup</option>
                    <option value="LinearSNPCoverageDisplay">SNP Coverage</option>
                    <option value="LinearReadArcsDisplay">Arc</option>
                    <option value="LinearReadCloudDisplay">Read Cloud</option>
                </param>
                <when value="LinearAlignmentsDisplay"/>
                    <!-- TODO add options from both LinearPileupDisplay and LinearSNPCoverageDisplay (doesn't work currently) -->
                <when value="LinearPileupDisplay"/>
                    <!-- TODO add more options (doesn't work currently) -->
                <when value="LinearSNPCoverageDisplay">
                    <!-- TODO add more options (doesn't work currently) -->
                    <param name="scale_type" type="select" label="Scale type">
                        <option value="linear" selected="true">Linear</option>
                        <option value="log">Log</option>
                    </param>
                    <param name="min_score" label="Min score" type="integer" value="" optional="true"/>
                    <param name="max_score" label="Max score" type="integer" value="" optional="true"/>
                </when>
                <when value="LinearReadArcsDisplay"/>
                    <!-- TODO add more options -->
                <when value="LinearReadCloudDisplay"/>
                    <!-- TODO add more options -->
            </conditional>
        </section>
    </xml>

    <xml name="track_styling_vcf">
        <section name="jbstyle" title="JBrowse Styling Options [Advanced]" expanded="false">
            <conditional name="track_style">
                <param name="display" type="select" label="Display style" help="How the track will be displayed by default">
                    <option value="LinearVariantDisplay" selected="true">Variant</option>
                    <option value="MultiLinearVariantDisplay">Multi-sample variant display (matrix)</option>
                    <option value="LinearVariantMatrixDisplay">Multi-sample variant display (regular)</option>
                    <option value="LinearPairedArcDisplay">Arc</option>
                </param>
                <when value="LinearVariantDisplay">
                    <!-- TODO does not work (jbrowse side) -->
                    <!--expand macro="track_styling_linear"/-->
                </when>
                <when value="MultiLinearVariantDisplay"/>
                <when value="LinearVariantMatrixDisplay"/>
                <when value="LinearPairedArcDisplay"/>
            </conditional>
        </section>
    </xml>

    <xml name="track_styling_bigwig">
        <section name="jbstyle" title="JBrowse Styling Options [Advanced]" expanded="false">
            <conditional name="track_style">
                <param name="display" type="select" label="Display style" help="How the track will be displayed by default">
                    <option value="LinearWiggleDisplay" selected="true">Wiggle</option>
                    <option value="MultiLinearWiggleDisplay" selected="true">Multiple Wiggle</option>
                </param>
                <when value="LinearWiggleDisplay">
                    <param name="wig_renderer" type="select" label="Renderer type">
                        <option value="xyplot" selected="true">XY Plot</option>
                        <option value="density">Density</option>
                        <option value="line">Line</option>
                    </param>

                    <!-- TODO not working -->
                    <!--param name="autoscale" type="select" label="Autoscale type">
                        <option value="local" selected="true">Local</option>
                        <option value="global">Global</option>
                        <option value="globalsd">Global ± 3σ</option>
                        <option value="localsd">Local ± 3σ</option>
                    </param>
                    <param name="resolution" label="Resolution" type="integer" value="1"/>
                    <param name="summaryScoreMode" type="select" label="Autoscale type">
                        <option value="max">Max</option>
                        <option value="min">Min</option>
                        <option value="avg">Avg</option>
                        <option value="whiskers" selected="true">Whiskers (combines all three)</option>
                    </param>
                    <param name="filled" label="Fill in histogram" type="boolean" checked="true" truevalue="true" falsevalue="false" />
                    <param name="scaleType" type="select" label="Scale type">
                        <option value="linear" selected="true">Linear</option>
                        <option value="log">Log</option>
                    </param>
                    <param name="displayCrossHatches" label="Draw cross hatches" type="boolean" checked="true" truevalue="true" falsevalue="false" />
                    <param name="minScore" label="Min score" type="integer" value="" optional="true"/>
                    <param name="maxScore" label="Max score" type="integer" value="" optional="true"/-->
                </when>
                <when value="MultiLinearWiggleDisplay">
                    <param name="wig_renderer" type="select" label="Renderer type">
                        <option value="multirowxy" selected="true">Multi row XY Plot</option>
                        <option value="xyplot">Multi XY Plot</option>
                        <option value="multirowdensity">Density</option>
                        <option value="multiline">Line</option>
                        <option value="multirowline">Row line</option>
                    </param>
                </when>
            </conditional>
        </section>
    </xml>

    <xml name="track_styling_hic">
        <section name="jbstyle" title="JBrowse Styling Options [Advanced]" expanded="false">
            <conditional name="track_style">
                <param name="display" type="select" label="Display style" help="How the track will be displayed by default">
                    <option value="LinearHicDisplay" selected="true">HiC</option>
                </param>
                <when value="LinearHicDisplay"/>
            </conditional>
        </section>
    </xml>

    <xml name="track_styling_gc">
        <section name="jbstyle" title="JBrowse Styling Options [Advanced]" expanded="false">
            <conditional name="track_style">
                <param name="display" type="select" label="Display style" help="How the track will be displayed by default">
                    <option value="LinearGCContentDisplay" selected="true">GC content</option>
                </param>
                <when value="LinearGCContentDisplay"/>
            </conditional>
        </section>
    </xml>

    <xml name="details_panel">
        <section name="formatdetails" title="Feature details panel customization [Advanced]" expanded="false">
            <param label="JEXL code to customize the top-level feature"
                    type="text"
                    name="formatdetails_feature"
                    optional="true"
                    help="e.g. jexl:{newfield:'Custom contents here: '+feature.name} (see https://jbrowse.org/jb2/docs/config_guides/customizing_feature_details/ for more details)">
                <expand macro="jexl_sanitize" />
            </param>
            <param label="JEXL code to customize the subfeatures"
                    type="text"
                    name="formatdetails_subfeature"
                    optional="true"
                    help="e.g. jexl:{newfield:'Custom contents here: '+feature.name} (see https://jbrowse.org/jb2/docs/config_guides/customizing_feature_details/ for more details)">
                <expand macro="jexl_sanitize" />
            </param>
            <param name="formatdetails_depth" label="Depth to customize the subfeatures to" type="integer" value="1"/>
        </section>
    </xml>

    <xml name="jexl_sanitize">
        <sanitizer>
            <mapping initial="galaxy.util.mapped_chars">
            <add source="&#10;" target=" " />
            <add source="&gt;" target="__gt__" />
            <add source="&lt;" target="__lt__" />
            </mapping>
            <valid initial="default">
                <add value="|" />
                <add value="{"/>
                <add value="}"/>
                <add value="!"/>
                <add value="?"/>
                <add value="&amp;"/>
                <add value="+"/>
                <add value="="/>
                <add value="'"/>
                <add value='"'/>
            </valid>
        </sanitizer>
    </xml>

    <xml name="input_conditional" token_label="Track Data" token_format="data">
        <param label="@LABEL@" format="@FORMAT@" name="annotation" type="data" multiple="True"/>
    </xml>

    <xml name="citations">
        <citations>
        <citation type="doi">10.1101/gr.094607.109</citation>
        </citations>
    </xml>
</macros>
